<?php
/**
 * Mod√®le User - Couche Data Access
 * G√®re l'authentification des administrateurs
 */

require_once __DIR__ . '/../config.php';

class User {
    private $pdo;
    
    public function __construct() {
        $this->pdo = getDatabaseConnection();
    }
    
    /**
     * Authentifie un utilisateur
     * @param string $username Nom d'utilisateur
     * @param string $password Mot de passe
     * @return array|null Donn√©es de l'utilisateur ou null si √©chec
     */
    public function authenticate($username, $password) {
        try {
            error_log("=== USER MODEL - DEBUT D'AUTHENTIFICATION ===");
            error_log("Tentative d'authentification pour: $username");
            
            $stmt = $this->pdo->prepare("
                SELECT id, username, email, role, password 
                FROM users 
                WHERE username = ?
            ");
            $stmt->execute([$username]);
            $user = $stmt->fetch();
            
            error_log("Utilisateur trouv√©: " . ($user ? 'Oui' : 'Non'));
            
            if ($user && password_verify($password, $user['password'])) {
                error_log("‚úÖ Authentification r√©ussie pour: " . $user['username']);
                error_log("R√¥le: " . $user['role']);
                
                // Ne pas retourner le mot de passe
                unset($user['password']);
                
                error_log("=== USER MODEL - FIN D'AUTHENTIFICATION ===");
                return $user;
            } else {
                error_log("‚ùå √âchec d'authentification pour: $username");
                if ($user) {
                    error_log("Mot de passe incorrect");
                } else {
                    error_log("Utilisateur non trouv√©");
                }
                error_log("=== USER MODEL - FIN D'AUTHENTIFICATION ===");
                return null;
            }
        } catch (PDOException $e) {
            error_log("üö® Erreur lors de l'authentification: " . $e->getMessage());
            error_log("Stack trace: " . $e->getTraceAsString());
            throw new Exception("Impossible d'authentifier l'utilisateur");
        }
    }
    
    /**
     * R√©cup√®re un utilisateur par son ID
     * @param int $id ID de l'utilisateur
     * @return array|null Donn√©es de l'utilisateur ou null si non trouv√©
     */
    public function getById($id) {
        try {
            error_log("=== USER MODEL - R√âCUP√âRATION PAR ID ===");
            error_log("ID demand√©: $id");
            
            $stmt = $this->pdo->prepare("
                SELECT id, username, email, role, created_at 
                FROM users 
                WHERE id = ?
            ");
            $stmt->execute([$id]);
            $result = $stmt->fetch();
            
            if ($result) {
                error_log("‚úÖ Utilisateur trouv√©: " . $result['username']);
            } else {
                error_log("‚ùå Utilisateur non trouv√© pour l'ID: $id");
            }
            
            error_log("=== USER MODEL - FIN R√âCUP√âRATION PAR ID ===");
            return $result ?: null;
        } catch (PDOException $e) {
            error_log("üö® Erreur lors de la r√©cup√©ration de l'utilisateur ID $id: " . $e->getMessage());
            error_log("Stack trace: " . $e->getTraceAsString());
            throw new Exception("Impossible de r√©cup√©rer l'utilisateur");
        }
    }
    
    /**
     * Cr√©e un nouvel utilisateur
     * @param array $data Donn√©es de l'utilisateur
     * @return int ID de l'utilisateur cr√©√©
     */
    public function create($data) {
        try {
            error_log("=== USER MODEL - DEBUT DE CR√âATION ===");
            error_log("Donn√©es re√ßues: " . json_encode($data));
            
            $hashedPassword = password_hash($data['password'], PASSWORD_DEFAULT);
            error_log("Mot de passe hash√©: " . substr($hashedPassword, 0, 20) . "...");
            
            $stmt = $this->pdo->prepare("
                INSERT INTO users (username, password, email, role) 
                VALUES (?, ?, ?, ?)
            ");
            $stmt->execute([
                $data['username'],
                $hashedPassword,
                $data['email'],
                $data['role'] ?? 'admin'
            ]);
            
            $newId = $this->pdo->lastInsertId();
            error_log("‚úÖ Utilisateur cr√©√© avec l'ID: $newId");
            error_log("=== USER MODEL - FIN DE CR√âATION ===");
            
            return $newId;
        } catch (PDOException $e) {
            error_log("üö® Erreur lors de la cr√©ation de l'utilisateur: " . $e->getMessage());
            error_log("Stack trace: " . $e->getTraceAsString());
            throw new Exception("Impossible de cr√©er l'utilisateur");
        }
    }
    
    /**
     * Met √† jour un utilisateur
     * @param int $id ID de l'utilisateur
     * @param array $data Donn√©es de l'utilisateur
     * @return bool True si mise √† jour r√©ussie
     */
    public function update($id, $data) {
        try {
            error_log("=== USER MODEL - DEBUT DE MISE √Ä JOUR ===");
            error_log("ID utilisateur: $id");
            error_log("Donn√©es re√ßues: " . json_encode($data));
            
            $updateFields = [];
            $params = [];
            
            if (isset($data['username'])) {
                $updateFields[] = "username = ?";
                $params[] = $data['username'];
            }
            
            if (isset($data['email'])) {
                $updateFields[] = "email = ?";
                $params[] = $data['email'];
            }
            
            if (isset($data['role'])) {
                $updateFields[] = "role = ?";
                $params[] = $data['role'];
            }
            
            if (isset($data['password']) && !empty($data['password'])) {
                $updateFields[] = "password = ?";
                $params[] = password_hash($data['password'], PASSWORD_DEFAULT);
            }
            
            if (empty($updateFields)) {
                error_log("‚ùå Aucun champ √† mettre √† jour");
                return false;
            }
            
            $params[] = $id;
            $sql = "UPDATE users SET " . implode(", ", $updateFields) . " WHERE id = ?";
            
            $stmt = $this->pdo->prepare($sql);
            $result = $stmt->execute($params);
            
            if ($result) {
                error_log("‚úÖ Utilisateur mis √† jour avec succ√®s");
            } else {
                error_log("‚ùå √âchec de la mise √† jour");
            }
            
            error_log("=== USER MODEL - FIN DE MISE √Ä JOUR ===");
            return $result;
        } catch (PDOException $e) {
            error_log("üö® Erreur lors de la mise √† jour de l'utilisateur: " . $e->getMessage());
            error_log("Stack trace: " . $e->getTraceAsString());
            throw new Exception("Impossible de mettre √† jour l'utilisateur");
        }
    }
    
    /**
     * Supprime un utilisateur
     * @param int $id ID de l'utilisateur
     * @return bool True si suppression r√©ussie
     */
    public function delete($id) {
        try {
            error_log("=== USER MODEL - DEBUT DE SUPPRESSION ===");
            error_log("ID utilisateur √† supprimer: $id");
            
            $stmt = $this->pdo->prepare("DELETE FROM users WHERE id = ?");
            $result = $stmt->execute([$id]);
            
            if ($result) {
                error_log("‚úÖ Utilisateur supprim√© avec succ√®s");
            } else {
                error_log("‚ùå √âchec de la suppression");
            }
            
            error_log("=== USER MODEL - FIN DE SUPPRESSION ===");
            return $result;
        } catch (PDOException $e) {
            error_log("üö® Erreur lors de la suppression de l'utilisateur: " . $e->getMessage());
            error_log("Stack trace: " . $e->getTraceAsString());
            throw new Exception("Impossible de supprimer l'utilisateur");
        }
    }
    
    /**
     * R√©cup√®re tous les utilisateurs
     * @return array Liste des utilisateurs
     */
    public function getAll() {
        try {
            error_log("=== USER MODEL - R√âCUP√âRATION DE TOUS LES UTILISATEURS ===");
            
            $stmt = $this->pdo->prepare("
                SELECT id, username, email, role, created_at 
                FROM users 
                ORDER BY username
            ");
            $stmt->execute();
            $users = $stmt->fetchAll();
            
            error_log("‚úÖ " . count($users) . " utilisateurs r√©cup√©r√©s");
            error_log("=== USER MODEL - FIN R√âCUP√âRATION ===");
            
            return $users;
        } catch (PDOException $e) {
            error_log("üö® Erreur lors de la r√©cup√©ration des utilisateurs: " . $e->getMessage());
            error_log("Stack trace: " . $e->getTraceAsString());
            throw new Exception("Impossible de r√©cup√©rer les utilisateurs");
        }
    }
    
    /**
     * V√©rifie si un nom d'utilisateur existe d√©j√†
     * @param string $username Nom d'utilisateur
     * @param int $excludeId ID √† exclure (pour la mise √† jour)
     * @return bool True si le nom d'utilisateur existe
     */
    public function usernameExists($username, $excludeId = null) {
        try {
            error_log("=== USER MODEL - V√âRIFICATION NOM D'UTILISATEUR ===");
            error_log("Username √† v√©rifier: $username");
            error_log("ID √† exclure: " . ($excludeId ?? 'Aucun'));
            
            $sql = "SELECT COUNT(*) FROM users WHERE username = ?";
            $params = [$username];
            
            if ($excludeId) {
                $sql .= " AND id != ?";
                $params[] = $excludeId;
            }
            
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($params);
            $count = $stmt->fetchColumn();
            
            $exists = $count > 0;
            error_log("Username existe: " . ($exists ? 'Oui' : 'Non'));
            error_log("=== USER MODEL - FIN V√âRIFICATION ===");
            
            return $exists;
        } catch (PDOException $e) {
            error_log("üö® Erreur lors de la v√©rification du nom d'utilisateur: " . $e->getMessage());
            throw new Exception("Impossible de v√©rifier le nom d'utilisateur");
        }
    }
    
    /**
     * V√©rifie si un email existe d√©j√†
     * @param string $email Email
     * @param int $excludeId ID √† exclure (pour la mise √† jour)
     * @return bool True si l'email existe
     */
    public function emailExists($email, $excludeId = null) {
        try {
            error_log("=== USER MODEL - V√âRIFICATION EMAIL ===");
            error_log("Email √† v√©rifier: $email");
            error_log("ID √† exclure: " . ($excludeId ?? 'Aucun'));
            
            $sql = "SELECT COUNT(*) FROM users WHERE email = ?";
            $params = [$email];
            
            if ($excludeId) {
                $sql .= " AND id != ?";
                $params[] = $excludeId;
            }
            
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($params);
            $count = $stmt->fetchColumn();
            
            $exists = $count > 0;
            error_log("Email existe: " . ($exists ? 'Oui' : 'Non'));
            error_log("=== USER MODEL - FIN V√âRIFICATION EMAIL ===");
            
            return $exists;
        } catch (PDOException $e) {
            error_log("üö® Erreur lors de la v√©rification de l'email: " . $e->getMessage());
            throw new Exception("Impossible de v√©rifier l'email");
        }
    }
}
?> 