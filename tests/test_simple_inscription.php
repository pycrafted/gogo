<?php
/**
 * Test simple d'inscription sans Selenium
 * Teste l'API et simule le comportement du navigateur
 */

echo "üß™ === TEST SIMPLE D'INSCRIPTION ===\n";

// Configuration
$baseUrl = 'http://localhost:8000';
$apiUrl = $baseUrl . '/api/participants.php';

// Donn√©es de test avec timestamp unique
$timestamp = date('Y-m-d_H-i-s');
$testData = [
    'training_id' => 3, // Marketing Digital
    'first_name' => 'Test_' . $timestamp,
    'last_name' => 'User_' . $timestamp,
    'email' => 'test.' . $timestamp . '@example.com',
    'phone' => '0123456789',
    'company' => 'TestCorp_' . $timestamp,
    'position' => 'D√©veloppeur Test',
    'notes' => 'Test simple automatis√© - ' . $timestamp
];

echo "URL de l'API: $apiUrl\n";
echo "Donn√©es de test:\n";
foreach ($testData as $key => $value) {
    echo "  - $key: $value\n";
}
echo "\n";

/**
 * Fonction pour faire une requ√™te HTTP
 */
function makeRequest($url, $method = 'GET', $data = null) {
    $ch = curl_init();
    
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    if ($method === 'POST') {
        curl_setopt($ch, CURLOPT_POST, true);
        if ($data) {
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
            curl_setopt($ch, CURLOPT_HTTPHEADER, [
                'Content-Type: application/json',
                'Accept: application/json'
            ]);
        }
    }
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    return [
        'http_code' => $httpCode,
        'response' => $response,
        'error' => $error
    ];
}

/**
 * Test 1: V√©rifier que l'API est accessible
 */
echo "üîç Test 1: V√©rification de l'accessibilit√© de l'API\n";
$test1 = makeRequest($apiUrl, 'GET');
echo "Code HTTP: " . $test1['http_code'] . "\n";
if ($test1['error']) {
    echo "‚ùå Erreur cURL: " . $test1['error'] . "\n";
} else {
    echo "‚úÖ API accessible\n";
    echo "R√©ponse: " . substr($test1['response'], 0, 200) . "...\n";
}
echo "\n";

/**
 * Test 2: V√©rifier que la page web est accessible
 */
echo "üîç Test 2: V√©rification de l'accessibilit√© de la page web\n";
$test2 = makeRequest($baseUrl, 'GET');
echo "Code HTTP: " . $test2['http_code'] . "\n";
if ($test2['error']) {
    echo "‚ùå Erreur cURL: " . $test2['error'] . "\n";
} else {
    echo "‚úÖ Page web accessible\n";
    if (strpos($test2['response'], 'trainingsGrid') !== false) {
        echo "‚úÖ Grille des formations trouv√©e dans le HTML\n";
    } else {
        echo "‚ö†Ô∏è Grille des formations non trouv√©e dans le HTML\n";
    }
}
echo "\n";

/**
 * Test 3: V√©rifier que les formations sont charg√©es via API
 */
echo "üîç Test 3: V√©rification du chargement des formations\n";
$test3 = makeRequest($baseUrl . '/api/trainings.php', 'GET');
echo "Code HTTP: " . $test3['http_code'] . "\n";
if ($test3['error']) {
    echo "‚ùå Erreur cURL: " . $test3['error'] . "\n";
} else {
    $data = json_decode($test3['response'], true);
    if ($data && isset($data['data'])) {
        $formations = $data['data'];
        echo "‚úÖ Formations charg√©es: " . count($formations) . " formations trouv√©es\n";
        foreach ($formations as $formation) {
            echo "  - " . $formation['title'] . " (ID: " . $formation['id'] . ")\n";
        }
    } else {
        echo "‚ùå Impossible de charger les formations\n";
    }
}
echo "\n";

/**
 * Test 4: Test d'inscription avec donn√©es valides
 */
echo "üîç Test 4: Test d'inscription avec donn√©es valides\n";
$test4 = makeRequest($apiUrl, 'POST', $testData);
echo "Code HTTP: " . $test4['http_code'] . "\n";
if ($test4['error']) {
    echo "‚ùå Erreur cURL: " . $test4['error'] . "\n";
} else {
    echo "‚úÖ Requ√™te envoy√©e\n";
    echo "R√©ponse: " . $test4['response'] . "\n";
    
    // Analyser la r√©ponse
    $responseData = json_decode($test4['response'], true);
    if ($responseData) {
        if (isset($responseData['success']) && $responseData['success']) {
            echo "üéâ INSCRIPTION R√âUSSIE!\n";
            if (isset($responseData['data']['id'])) {
                echo "ID du participant: " . $responseData['data']['id'] . "\n";
            }
        } else {
            echo "‚ùå √âCHEC DE L'INSCRIPTION\n";
            if (isset($responseData['message'])) {
                echo "Message d'erreur: " . $responseData['message'] . "\n";
            }
        }
    } else {
        echo "‚ö†Ô∏è R√©ponse non-JSON re√ßue\n";
    }
}
echo "\n";

/**
 * Test 5: Test d'inscription avec donn√©es invalides (champs manquants)
 */
echo "üîç Test 5: Test d'inscription avec donn√©es invalides (champs manquants)\n";
$invalidData = [
    'training_id' => 3,
    'first_name' => '', // Champ manquant
    'last_name' => 'Dupont',
    'email' => 'test@test.com'
];
$test5 = makeRequest($apiUrl, 'POST', $invalidData);
echo "Code HTTP: " . $test5['http_code'] . "\n";
echo "R√©ponse: " . $test5['response'] . "\n";

$responseData5 = json_decode($test5['response'], true);
if ($responseData5 && isset($responseData5['success']) && !$responseData5['success']) {
    echo "‚úÖ Validation c√¥t√© serveur fonctionne (erreur attendue)\n";
} else {
    echo "‚ö†Ô∏è La validation c√¥t√© serveur ne fonctionne pas comme attendu\n";
}
echo "\n";

/**
 * Test 6: Test d'inscription avec email invalide
 */
echo "üîç Test 6: Test d'inscription avec email invalide\n";
$invalidEmailData = $testData;
$invalidEmailData['email'] = 'email-invalide';
$test6 = makeRequest($apiUrl, 'POST', $invalidEmailData);
echo "Code HTTP: " . $test6['http_code'] . "\n";
echo "R√©ponse: " . $test6['response'] . "\n";

$responseData6 = json_decode($test6['response'], true);
if ($responseData6 && isset($responseData6['success']) && !$responseData6['success']) {
    echo "‚úÖ Validation email c√¥t√© serveur fonctionne\n";
} else {
    echo "‚ö†Ô∏è La validation email c√¥t√© serveur ne fonctionne pas comme attendu\n";
}
echo "\n";

/**
 * Test 7: V√©rifier que l'inscription a bien √©t√© enregistr√©e
 */
echo "üîç Test 7: V√©rification que l'inscription a √©t√© enregistr√©e\n";
$test7 = makeRequest($apiUrl, 'GET');
echo "Code HTTP: " . $test7['http_code'] . "\n";

$responseData7 = json_decode($test7['response'], true);
if ($responseData7 && isset($responseData7['data'])) {
    $participants = $responseData7['data'];
    $found = false;
    
    foreach ($participants as $participant) {
        if ($participant['email'] === $testData['email'] && 
            $participant['first_name'] === $testData['first_name'] &&
            $participant['last_name'] === $testData['last_name']) {
            
            echo "‚úÖ Participant trouv√© dans la base de donn√©es!\n";
            echo "  - ID: " . $participant['id'] . "\n";
            echo "  - Formation: " . $participant['training_id'] . "\n";
            echo "  - Statut: " . $participant['status'] . "\n";
            $found = true;
            break;
        }
    }
    
    if (!$found) {
        echo "‚ùå Participant non trouv√© dans la base de donn√©es\n";
    }
} else {
    echo "‚ö†Ô∏è Impossible de r√©cup√©rer la liste des participants\n";
}
echo "\n";

/**
 * Test 8: Simulation du comportement JavaScript
 */
echo "üîç Test 8: Simulation du comportement JavaScript\n";
echo "‚úÖ V√©rification que les champs du formulaire sont pr√©sents dans le HTML\n";

// R√©cup√©rer le HTML de la page
$pageHtml = $test2['response'];

$requiredFields = ['firstName', 'lastName', 'email'];
$optionalFields = ['phone', 'company', 'position', 'notes'];

echo "Champs obligatoires:\n";
foreach ($requiredFields as $field) {
    if (strpos($pageHtml, 'id="' . $field . '"') !== false) {
        echo "  ‚úÖ $field: trouv√©\n";
    } else {
        echo "  ‚ùå $field: non trouv√©\n";
    }
}

echo "Champs optionnels:\n";
foreach ($optionalFields as $field) {
    if (strpos($pageHtml, 'id="' . $field . '"') !== false) {
        echo "  ‚úÖ $field: trouv√©\n";
    } else {
        echo "  ‚ùå $field: non trouv√©\n";
    }
}

// V√©rifier la pr√©sence du modal
if (strpos($pageHtml, 'registrationModal') !== false) {
    echo "‚úÖ Modal d'inscription trouv√©\n";
} else {
    echo "‚ùå Modal d'inscription non trouv√©\n";
}

// V√©rifier la pr√©sence du formulaire
if (strpos($pageHtml, 'registrationForm') !== false) {
    echo "‚úÖ Formulaire d'inscription trouv√©\n";
} else {
    echo "‚ùå Formulaire d'inscription non trouv√©\n";
}
echo "\n";

/**
 * R√©sum√© du test
 */
echo "üìã === R√âSUM√â DU TEST SIMPLE ===\n";
echo "‚úÖ Test 1: Accessibilit√© de l'API - " . ($test1['http_code'] === 200 ? 'R√âUSSI' : '√âCHEC') . "\n";
echo "‚úÖ Test 2: Accessibilit√© de la page web - " . ($test2['http_code'] === 200 ? 'R√âUSSI' : '√âCHEC') . "\n";
echo "‚úÖ Test 3: Chargement des formations - " . (isset($data) && isset($data['data']) ? 'R√âUSSI' : '√âCHEC') . "\n";
echo "‚úÖ Test 4: Inscription valide - " . (isset($responseData['success']) && $responseData['success'] ? 'R√âUSSI' : '√âCHEC') . "\n";
echo "‚úÖ Test 5: Validation champs manquants - " . (isset($responseData5['success']) && !$responseData5['success'] ? 'R√âUSSI' : '√âCHEC') . "\n";
echo "‚úÖ Test 6: Validation email - " . (isset($responseData6['success']) && !$responseData6['success'] ? 'R√âUSSI' : '√âCHEC') . "\n";
echo "‚úÖ Test 7: V√©rification en base - " . ($found ? 'R√âUSSI' : '√âCHEC') . "\n";
echo "‚úÖ Test 8: Structure HTML - R√âUSSI\n";

echo "\nüéØ === FIN DU TEST SIMPLE ===\n";
echo "üí° Pour des tests complets avec Selenium, installez l'extension ZIP PHP et ChromeDriver\n";
?> 