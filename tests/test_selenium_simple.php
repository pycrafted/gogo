<?php
/**
 * Test Selenium simplifi√© pour simuler la saisie utilisateur r√©elle
 * Utilise ChromeDriver directement sans d√©pendances Composer
 */

echo "üß™ === TEST SELENIUM SIMPLIFI√â ===\n";

// Configuration
$baseUrl = 'http://localhost:8000';
$timestamp = date('Y-m-d_H-i-s');
$testData = [
    'first_name' => 'Test_' . $timestamp,
    'last_name' => 'User_' . $timestamp,
    'email' => 'test.' . $timestamp . '@example.com',
    'phone' => '0123456789',
    'company' => 'TestCorp_' . $timestamp,
    'position' => 'D√©veloppeur Test',
    'notes' => 'Test Selenium utilisateur - ' . $timestamp
];

echo "URL de test: $baseUrl\n";
echo "Donn√©es de test:\n";
foreach ($testData as $key => $value) {
    echo "  - $key: $value\n";
}
echo "\n";

/**
 * V√©rifier que ChromeDriver est disponible
 */
function checkChromeDriver() {
    echo "üîç V√©rification de ChromeDriver...\n";
    
    // Chercher ChromeDriver dans diff√©rents emplacements
    $possiblePaths = [
        'chromedriver.exe',
        './chromedriver.exe',
        'C:/Windows/System32/chromedriver.exe',
        'C:/Program Files/Google/Chrome/Application/chromedriver.exe'
    ];
    
    foreach ($possiblePaths as $path) {
        if (file_exists($path)) {
            echo "‚úÖ ChromeDriver trouv√©: $path\n";
            return $path;
        }
    }
    
    echo "‚ùå ChromeDriver non trouv√©\n";
    echo "üì• T√©l√©chargez ChromeDriver depuis: https://chromedriver.chromium.org/\n";
    echo "üìÅ Placez chromedriver.exe dans le r√©pertoire du projet\n";
    return false;
}

/**
 * Lancer ChromeDriver
 */
function startChromeDriver($driverPath) {
    echo "üöÄ D√©marrage de ChromeDriver...\n";
    
    // Lancer ChromeDriver en arri√®re-plan
    $command = "start /B \"\" \"$driverPath\" --port=4444 --whitelisted-ips=\"\"";
    exec($command);
    
    // Attendre que ChromeDriver d√©marre
    sleep(3);
    
    echo "‚úÖ ChromeDriver d√©marr√©\n";
}

/**
 * Faire une requ√™te vers ChromeDriver
 */
function seleniumRequest($method, $url, $data = null) {
    $ch = curl_init();
    
    curl_setopt($ch, CURLOPT_URL, "http://localhost:4444$url");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Accept: application/json'
    ]);
    
    if ($method === 'POST') {
        curl_setopt($ch, CURLOPT_POST, true);
        if ($data) {
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        }
    }
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    return [
        'http_code' => $httpCode,
        'response' => $response,
        'error' => $error
    ];
}

/**
 * Test principal
 */
function runSeleniumTest($testData) {
    echo "üîç Test 1: V√©rification de l'accessibilit√© de ChromeDriver\n";
    
    // V√©rifier que ChromeDriver r√©pond
    $test = seleniumRequest('GET', '/status');
    if ($test['http_code'] === 200) {
        echo "‚úÖ ChromeDriver accessible\n";
    } else {
        echo "‚ùå ChromeDriver non accessible\n";
        return false;
    }
    
    echo "\nüîç Test 2: Ouverture de la page web\n";
    
    // Cr√©er une nouvelle session
    $sessionData = [
        'capabilities' => [
            'browserName' => 'chrome',
            'goog:chromeOptions' => [
                'args' => [
                    '--headless',
                    '--no-sandbox',
                    '--disable-dev-shm-usage',
                    '--disable-gpu',
                    '--window-size=1920,1080'
                ]
            ]
        ]
    ];
    
    $session = seleniumRequest('POST', '/session', $sessionData);
    if ($session['http_code'] !== 200) {
        echo "‚ùå Impossible de cr√©er une session Chrome\n";
        return false;
    }
    
    $sessionData = json_decode($session['response'], true);
    $sessionId = $sessionData['value']['sessionId'];
    echo "‚úÖ Session Chrome cr√©√©e: $sessionId\n";
    
    // Naviguer vers la page
    $navigateData = ['url' => 'http://localhost:8000'];
    $navigate = seleniumRequest('POST', "/session/$sessionId/url", $navigateData);
    
    if ($navigate['http_code'] === 200) {
        echo "‚úÖ Navigation vers la page r√©ussie\n";
    } else {
        echo "‚ùå √âchec de la navigation\n";
        return false;
    }
    
    echo "\nüîç Test 3: Attendre le chargement de la page\n";
    sleep(3);
    
    echo "\nüîç Test 4: Rechercher les boutons d'inscription\n";
    
    // Chercher les boutons d'inscription
    $findElementsData = [
        'using' => 'css selector',
        'value' => '.btn-inscription, button[onclick*="inscription"], a[href*="inscription"]'
    ];
    
    $buttons = seleniumRequest('POST', "/session/$sessionId/elements", $findElementsData);
    
    if ($buttons['http_code'] === 200) {
        $buttonsData = json_decode($buttons['response'], true);
        $buttonCount = count($buttonsData['value']);
        echo "‚úÖ Boutons d'inscription trouv√©s: $buttonCount\n";
        
        if ($buttonCount > 0) {
            echo "\nüîç Test 5: Cliquer sur le premier bouton d'inscription\n";
            
            // Cliquer sur le premier bouton
            $clickData = ['id' => $buttonsData['value'][0]['ELEMENT']];
            $click = seleniumRequest('POST', "/session/$sessionId/element/{$clickData['id']}/click", []);
            
            if ($click['http_code'] === 200) {
                echo "‚úÖ Clic sur le bouton d'inscription r√©ussi\n";
                
                echo "\nüîç Test 6: Attendre l'ouverture du modal\n";
                sleep(2);
                
                echo "\nüîç Test 7: Remplir le formulaire\n";
                
                // Remplir les champs obligatoires
                $fields = [
                    'firstName' => $testData['first_name'],
                    'lastName' => $testData['last_name'],
                    'email' => $testData['email']
                ];
                
                foreach ($fields as $fieldId => $value) {
                    echo "  - Remplissage du champ $fieldId avec: $value\n";
                    
                    // Chercher le champ
                    $findFieldData = [
                        'using' => 'id',
                        'value' => $fieldId
                    ];
                    
                    $field = seleniumRequest('POST', "/session/$sessionId/element", $findFieldData);
                    
                    if ($field['http_code'] === 200) {
                        $fieldData = json_decode($field['response'], true);
                        $fieldElementId = $fieldData['value']['ELEMENT'];
                        
                        // Vider le champ
                        $clearData = ['id' => $fieldElementId];
                        seleniumRequest('POST', "/session/$sessionId/element/{$fieldElementId}/clear", []);
                        
                        // Remplir le champ
                        $sendKeysData = ['text' => $value];
                        $sendKeys = seleniumRequest('POST', "/session/$sessionId/element/{$fieldElementId}/value", $sendKeysData);
                        
                        if ($sendKeys['http_code'] === 200) {
                            echo "    ‚úÖ Champ $fieldId rempli\n";
                        } else {
                            echo "    ‚ùå √âchec du remplissage du champ $fieldId\n";
                        }
                    } else {
                        echo "    ‚ùå Champ $fieldId non trouv√©\n";
                    }
                }
                
                echo "\nüîç Test 8: Soumettre le formulaire\n";
                
                // Chercher le bouton de soumission
                $submitButtonData = [
                    'using' => 'css selector',
                    'value' => '#registrationModal .btn-success, button[onclick*="submitRegistration"]'
                ];
                
                $submitButton = seleniumRequest('POST', "/session/$sessionId/element", $submitButtonData);
                
                if ($submitButton['http_code'] === 200) {
                    $submitButtonData = json_decode($submitButton['response'], true);
                    $submitElementId = $submitButtonData['value']['ELEMENT'];
                    
                    // Cliquer sur le bouton de soumission
                    $submitClick = seleniumRequest('POST', "/session/$sessionId/element/{$submitElementId}/click", []);
                    
                    if ($submitClick['http_code'] === 200) {
                        echo "‚úÖ Formulaire soumis avec succ√®s\n";
                        
                        echo "\nüîç Test 9: V√©rifier le succ√®s de l'inscription\n";
                        sleep(2);
                        
                        // V√©rifier s'il y a une notification de succ√®s
                        $notificationData = [
                            'using' => 'css selector',
                            'value' => '.alert-success, .toast-success, .notification-success'
                        ];
                        
                        $notification = seleniumRequest('POST', "/session/$sessionId/element", $notificationData);
                        
                        if ($notification['http_code'] === 200) {
                            echo "‚úÖ Notification de succ√®s trouv√©e\n";
                        } else {
                            echo "‚ö†Ô∏è Aucune notification de succ√®s trouv√©e\n";
                        }
                        
                    } else {
                        echo "‚ùå √âchec de la soumission du formulaire\n";
                    }
                } else {
                    echo "‚ùå Bouton de soumission non trouv√©\n";
                }
                
            } else {
                echo "‚ùå √âchec du clic sur le bouton d'inscription\n";
            }
        } else {
            echo "‚ùå Aucun bouton d'inscription trouv√©\n";
        }
    } else {
        echo "‚ùå Impossible de chercher les boutons d'inscription\n";
    }
    
    // Fermer la session
    echo "\nüîç Test 10: Fermeture de la session\n";
    seleniumRequest('DELETE', "/session/$sessionId");
    echo "‚úÖ Session ferm√©e\n";
    
    return true;
}

/**
 * Test de v√©rification en base de donn√©es
 */
function verifyDatabaseEntry($testData) {
    echo "\nüîç Test 11: V√©rification en base de donn√©es\n";
    
    $apiUrl = 'http://localhost:8000/api/participants.php';
    $response = makeApiRequest($apiUrl, 'GET');
    
    if ($response['http_code'] === 200) {
        $data = json_decode($response['response'], true);
        
        if ($data && isset($data['data'])) {
            $participants = $data['data'];
            $found = false;
            
            foreach ($participants as $participant) {
                if ($participant['email'] === $testData['email'] &&
                    $participant['first_name'] === $testData['first_name'] &&
                    $participant['last_name'] === $testData['last_name']) {
                    
                    echo "‚úÖ Participant trouv√© en base de donn√©es!\n";
                    echo "  - ID: " . $participant['id'] . "\n";
                    echo "  - Formation: " . $participant['training_id'] . "\n";
                    echo "  - Statut: " . $participant['status'] . "\n";
                    $found = true;
                    break;
                }
            }
            
            if (!$found) {
                echo "‚ùå Participant non trouv√© en base de donn√©es\n";
            }
        } else {
            echo "‚ö†Ô∏è Impossible de r√©cup√©rer les donn√©es de l'API\n";
        }
    } else {
        echo "‚ö†Ô∏è Erreur lors de la v√©rification API\n";
    }
}

/**
 * Fonction utilitaire pour les requ√™tes API
 */
function makeApiRequest($url, $method = 'GET', $data = null) {
    $ch = curl_init();
    
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    if ($method === 'POST') {
        curl_setopt($ch, CURLOPT_POST, true);
        if ($data) {
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
            curl_setopt($ch, CURLOPT_HTTPHEADER, [
                'Content-Type: application/json',
                'Accept: application/json'
            ]);
        }
    }
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    return [
        'http_code' => $httpCode,
        'response' => $response,
        'error' => $error
    ];
}

// Lancer le test
echo "üöÄ === LANCEMENT DU TEST SELENIUM SIMPLIFI√â ===\n";

// V√©rifier ChromeDriver
$driverPath = checkChromeDriver();
if (!$driverPath) {
    echo "‚ùå ChromeDriver requis pour ce test\n";
    echo "üí° Utilisez le test simple: .\\scripts\\test_simple.ps1\n";
    exit(1);
}

// D√©marrer ChromeDriver
startChromeDriver($driverPath);

// Lancer le test Selenium
$success = runSeleniumTest($testData);

// V√©rifier en base de donn√©es
if ($success) {
    verifyDatabaseEntry($testData);
}

echo "\nüìã === R√âSUM√â DU TEST SELENIUM ===\n";
if ($success) {
    echo "‚úÖ Test Selenium r√©ussi - Simulation utilisateur compl√®te\n";
} else {
    echo "‚ùå Test Selenium √©chou√©\n";
}

echo "\nüéØ === FIN DU TEST SELENIUM ===\n";
?> 